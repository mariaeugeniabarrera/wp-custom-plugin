<!DOCTYPE html>
<html lang="en">
<head>
  <title>Informes</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="js/jquery-1.12.4.js"></script>
  <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />
  <!--<script type="text/javascript" src='https://maps.google.com/maps/api/js?sensor=false&libraries=places'></script>-->
  <link rel="stylesheet" src='https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css'>
  <link rel="stylesheet" href="css/loader.css">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <link href='https://fonts.googleapis.com/css?family=Ubuntu:400,500' rel='stylesheet' type='text/css'>
<style>
body {
	background-image: url(images/15.jpg);
	background-size: 100% auto;
	font-family: 'Ubuntu', sans-serif;
}
input {
	margin-top:10px;
	width:70%;
}
label {
	margin-top:10px;
}
.label-danger {
	/*margin-top:40px;*/
	font-weight: 100;
    padding-left: 20px;
	padding-right: 20px;
	padding-top: 10px;
	padding-bottom: 10px;
    font-size: 14px;
}
.titulo_destino {
	cursor:pointer;
	/*color:#64B2C8;*/
	text-decoration: underline;
	color:#6DDAEF;
}
.titulo_destino:hover, .titulo_destino:focus, .titulo_destino:active {
	color:#E67B81;
}
ul {
	list-style-type:none
    /*  list-style-image: url(); http://fuady99.xtgem.com/images/bullet_icon_2.gif  http://www.apcopay.eu/wp-content/themes/apcopay/pics/leftmenu-bullet-icon.png 'http://icons.iconarchive.com/icons/taytel/orb/16/bullet-2-icon.png'*/
}
.mi-boton {
	background-color:#1abc9c;
	color:#fff;
	text-transform:uppercase;
	text-decoration:none;
	padding:5px 20px;
	border-radius:20px;
	outline:0!important;
	font-smoothing:antialiased;
	-webkit-transition:all .2s ease-in-out;
	transition:all .2s ease-in-out;
	border:0;
	font-size:12px;
	margin-bottom:10px;
}
#destinatarios li {
	/*background-color: rgba(26, 188, 156, 0.6); //9BD7FE */
	border-radius: 200px;
	margin-bottom: 10px;
	margin-right: 30px;
	color:#fff;
	height:27px;
	font-size:10px;
	background: #43cea2; /* fallback for old browsers */
	background: -webkit-linear-gradient(to left, #43cea2 , #185a9d); /* Chrome 10-25, Safari 5.1-6 */
	background: linear-gradient(to left, #43cea2 , #185a9d); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
}
.modal-body {
	padding:0px;
}
.mi-boton:hover {
	background-color:#13866f
}
.panel {
	margin-top:20px;
}
.informes-heading {
	padding-top:20px;
	padding-bottom:20px;
	color: #fff;
	font-size:16px;
	border-radius: 4px 4px 0px 0px;
	background: #6441A5; 
	background: -webkit-linear-gradient(to left, #6441A5 , #2a0845); 
	background: linear-gradient(to left, #6441A5 , #2a0845);
}
#informes-panel {
	border-color: #2a0845;
}
.informe-heading {
	padding-top:20px;
	padding-bottom:20px;
	color: #fff;
	font-size:16px;
	border-radius: 4px 4px 0px 0px;
	background: #6441A5; 
	background: -webkit-linear-gradient(to left, #6441A5 , #2a0845); 
	background: linear-gradient(to left, #6441A5 , #2a0845);
}
#informe-panel {
	border-color: #2a0845;
}
@media only screen and (max-width: 767px) {
	.row {
		width: 100%;
		margin-top:20px;
	}
}
@media screen and (min-width: 767px) {
	.row {
		width: 100%;
		margin-top:20px;
	}
}
</style>

<script>
$(document).ready(function() {
		var date = new Date();
		var month = date.getMonth();
		var year = date.getFullYear();
		var months = new Array();
		months[0] = "Enero";
		months[1] = "Febrero";
		months[2] = "Marzo";
		months[3] = "Abril";
		months[4] = "Mayo";
		months[5] = "Junio";
		months[6] = "Julio";
		months[7] = "Agosto";
		months[8] = "Septiembre";
		months[9] = "Octubre";
		months[10] = "Noviembre";
		months[11] = "Diciembre";
		var month_name = months[date.getMonth()];
		var ver_informe_cliente = '';
		var ver_informe_fecha = '';
		
		
		function getCookie(cname) {
			var name = cname + "=";
			var ca = document.cookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length,c.length);
				}
			}
			return "";
		}
		
		var user = getCookie('session');
		console.log("Usuario: " + user);

		if(!user){
			window.location = 'index.html';
		}
		
		getNewVal=function(valor){
			console.log(valor);
			if(valor<=12){
				month = valor;
			}else{
				year = valor;
			}
			getInformes();
		}
		
		function FillMonthYear(){
			console.log("FillMonthYear");
			var statistics_panel = document.getElementById('contenedor_dropdown');
			var mi_html = '';
			mi_html+='<div class="form-group" style="width:150px;display:inline-block;margin-right:20px;">'+
			'<label for="sel1">Mes</label>'+
			'<select id="mes" onchange="getNewVal(this.value);" class="form-control" id="sel1">';
			
			for(var v=0;v<=months.length;v++){
				if(v==month){
					mi_html+='<option value="'+(v)+'" selected>'+month_name+'</option>';
				}else{
					mi_html+='<option value="'+(v)+'">'+months[v]+'</option>';
				}
			}
			mi_html+='</select></div>';
			
			mi_html+='<div class="form-group" style="width:150px;display:inline-block;">'+
			'<label for="sel1">AÃ±o</label>'+
			'<select id="anio" onchange="getNewVal(this.value);" class="form-control" id="sel1">';
			
			for(var b=(year-4);b<(year+3);b++){
				if(b==year){
					mi_html+='<option value="'+b+'" selected>'+b+'</option>';
				}else{
					mi_html+='<option value="'+b+'">'+b+'</option>';
				}
			}
			mi_html+='</select></div>';
			
			statistics_panel.innerHTML+=mi_html;
		}
		FillMonthYear();
		
		
		$('#dialog').dialog({ modal: true, autoOpen: false });

		preview = function() {
		  console.log(tinyMCE.activeEditor.getContent());
		  $('#dialog').html(tinyMCE.activeEditor.getContent()); //v
		  $('#dialog').dialog('open');
		}
		
		save_template = function(){
			console.log("Save Template");
			$.post( "controllers/data.php",
			{
				'data':'save_informe_template'
			}, function( data ) {
				console.log(JSON.stringify(data));
			});
		}
		
		logout = function() {
			$.post( "controllers/data.php",
			{
				'data':'logout'
			}, function( data ) {
				window.location = 'index.html';
			});	
		}
		
		getInformes = function(){
			console.log("Informes");
			console.log("Mes " + month);
			console.log("Anio " + year);
			document.getElementById('informes_body').innerHTML = '';
			var month_with_cero = 0;
			if(month<10){
				month_with_cero = '0'+(parseInt(month)+1);
			}else{
				month_with_cero = parseInt(month)+1;
			}
			console.log(year+'-'+month_with_cero);
			$.post( "controllers/data.php",
			{
				'data':'ver_informes_enviados',
				'fecha':year+'-'+month_with_cero
			}, function( data ) {
				console.log(JSON.stringify(data));
				data = JSON.parse(data);
				for(var i=0;i<data.length;i++)
				{
					var q = "ver_informe('"+year+"-"+month_with_cero+"','"+data[i].cliente+"')";
					document.getElementById('informes_body').innerHTML += '<tr>' +
					'<td>' + data[i].fecha + '</td>' + 
					'<td>' + data[i].cliente + '</td>' + 
					'<td><button type="button" class="mi-boton" onclick="'+q+'">Ver Informe</button></td>'+
					'</tr>';
				}
				$('#loader2').hide();
				$('#informes').DataTable({"iDisplayLength":5});
			});
		}
		getInformes();
		
		ver_informe = function(fecha, cliente){
			console.log("Ver Informe");
			console.log("Fecha " + fecha);
			console.log("Cliente " + cliente);
			ver_informe_cliente = cliente;
			ver_informe_fecha = fecha;
			$.post( "controllers/data.php",
			{
				'data':'ver_informe_enviado',
				'fecha':fecha,
				'cliente':cliente
			}, function( data ) {
				console.log(JSON.stringify(data));
				data = JSON.parse(data);
				tinyMCE.activeEditor.setContent("");
				for(var i=0;i<data.length;i++)
				{
					tinyMCE.activeEditor.setContent(data[i].informe);
					$('#myModal').modal('hide');
				}
			});
		}
		
		enviar = function(){
			console.log("Enviar Informes");
			//'template_html':tinyMCE.activeEditor.getContent()
			$.post( "controllers/enviar_informes.php",
			{
				'mes_text':month_name,
				'anio':year,
				'mes':month,
				'email_destino':'alejandro@grupodeboss.com'
			}, function( data ) {
				//console.log(JSON.stringify(data));
				data = JSON.parse(data);
				for(var i=0;i<data.length;i++)
				{
					//console.log("Data: " + data[i]);
					document.getElementById('destinatarios').innerHTML += '<li>' + data[i] + '</li>';
				}
				$('#myModalLabel').html("Informes Enviados");
				$('#loader').hide();
				
			});
		}
		reenviar = function(){
			console.log("Re-Enviar Informes");
			document.getElementById('destinatarios').innerHTML = '';
			$.post( "controllers/enviar_informe_individual.php",
			{
				'fecha':ver_informe_fecha,
				'cliente':ver_informe_cliente
			}, function( data ) {
				console.log(JSON.stringify(data));
				if(data==true)
				{
					var q = "ver_informe('"+ver_informe_fecha+"','"+ver_informe_cliente+"')";
					var datetime = date.getDate() + "/"
					+ (date.getMonth()+1)  + "/" 
					+ date.getFullYear() + " @ "  
					+ date.getHours() + ":"  
					+ date.getMinutes() + ":" 
					+ date.getSeconds();
					document.getElementById('destinatarios').innerHTML += '<li style="margin-bottom:150px;margin-top:150px;">' + 
					' <button type="button" class="mi-boton" onclick="'+q+'">Ver Informe</button>' +
					'<span class="titulo_destino"> '+datetime+'</span> '+ver_informe_cliente
					
					+ '</li>';
					
					$('#myModalLabel').html("Informes Enviados");
					$('#loader').hide();
				}else{
					$('#loader').hide();
					document.getElementById('destinatarios').innerHTML = '<p>Hubo un error, por favor intente de nuevo mas tarde.</p>';
				}
			});
		}
});
</script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<script type="text/javascript" src='https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js'></script>
<script type="text/javascript" src='https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js'></script>
<script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
<script>tinymce.init({ 
selector: 'textarea',
  height: 500,
  plugins: [
        "advlist autolink lists link image charmap print preview anchor",
        "searchreplace visualblocks code fullscreen",
        "insertdatetime media table contextmenu paste imagetools"
    ],
    toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
  imagetools_cors_hosts: ['www.tinymce.com', 'codepen.io'],
  content_css: [
    '//fast.fonts.net/cssapi/e6dc9b99-64fe-4292-ad98-6974f93cd2a2.css',
    '//www.tinymce.com/css/codepen.min.css'
  ]
});</script>
</head>
<body>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Enviando Informes...</h4>
      </div>
      <div id="contenido_popup" class="modal-body" style="background-image:url('https://image.freepik.com/free-vector/abstract-blue-background_1048-1511.jpg');background-repeat:no-repeat;background-size:100% auto;">
          <!-- Ajax Loader -->
		  <div id="loader" style="padding-top:150px;padding-bottom:100px;">
		  <div class="cssload-thecube">
			<div class="cssload-cube cssload-c1"></div>
			<div class="cssload-cube cssload-c2"></div>
			<div class="cssload-cube cssload-c4"></div>
			<div class="cssload-cube cssload-c3"></div>
		  </div>
		  <!--<div id="load_message" style="margin-top:20px;margin-bottom:20px;">Enviando...</div>-->
		  </div>
		  <!-- ./ Ajax Loader -->
		  <ul id="destinatarios" style="padding-top:50px;">
		  </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- ./Modal -->

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html"><img alt="Brand" src="images/logo_gd_29x30.png" height="100%"></a>
    </div>
    <ul class="nav navbar-nav">
	  <li><a href="index.html">Ver Datos</a></li>
      <li><a href="clientes.html">Clientes</a></li>
	  <li><a href="notas.html">Notas</a></li>
      <li  class="active"><a href="informes_enviados.html">Informes</a></li>
      <li><a href="banner.html">Banners</a></li>
    </ul>
	<form class="navbar-form navbar-left" role="">
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal" onclick="enviar()">Enviar Informes</button>
	</form>
	<form class="navbar-form navbar-right" role="">
		<button type="button" class="btn btn-default" onclick="logout()">Logout</button>
	</form>
  </div>
</nav>

<div align="center">
<div class="row">

<div class="col-sm-7" style="display:inline-block;">
	<div id="informe-panel" class="panel panel-default" align="center">
	 <div class="informe-heading">Informe Enviado</div>
	  <div class="panel-body">
	  <textarea id="mytext" name="mytext"></textarea> <!-- Aca dentro tengo que insertar el html del reporte, con datos de ejemplo -->
	  <p></p>
	  <!--<button type="button" class="btn btn-primary" onclick="preview()">Pre Visualizar Plantilla</button>
	  <button type="button" class="btn btn-primary" onclick="save_template()">Guardar</button>-->
	  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="reenviar()">Reenviar Informe</button>  
	</div>
	</div>
</div>

<div class="col-sm-5" style="display:inline-block;">
	<div id="informes-panel" class="panel panel-default" align="center">
	 <div class="informes-heading">Informes Enviados</div>
	  <div class="panel-body">
		  <div id="contenedor_dropdown">
		  </div>
		  <!-- Informes Enviados -->
		  <table id="informes" class="table table-striped">
			<thead>
			  <tr>
				<th>Fecha</th>
				<th>Cliente</th>
				<th>Ver Informe</th>
			  </tr>
			</thead>
			<tbody id="informes_body">
			</tbody>
		  </table>
		  <!-- ./ Informes Enviados -->
		  <!-- Ajax Loader -->
		  <div id="loader2">
		  <div class="cssload-thecube">
			<div class="cssload-cube cssload-c1"></div>
			<div class="cssload-cube cssload-c2"></div>
			<div class="cssload-cube cssload-c4"></div>
			<div class="cssload-cube cssload-c3"></div>
		  </div>
		  <div id="load_message" style="margin-top:20px;margin-bottom:20px;">Loading...</div>
		  </div>
		  <!-- ./ Ajax Loader -->
	</div>
	</div>
	</div> 
</div>

</div>
</div><!-- ./ Center -->

</body>
</html>